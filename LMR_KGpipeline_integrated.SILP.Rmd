---
title: "R Notebook"
author: "Laila Rad adapted from Kate Griffin"
Date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_notebook: default
editor_options: 
  markdown: 
    wrap: 72
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you
execute code within the notebook, the results appear beneath the code.

Try executing this chunk by clicking the *Run* button within the chunk
or by placing your cursor inside it and pressing *Cmd+Shift+Enter*.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or
by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output
will be saved alongside it (click the *Preview* button or press
*Cmd+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the
editor. Consequently, unlike *Knit*, *Preview* does not run any R code
chunks. Instead, the output of the chunk when it was last run in the
editor is displayed.

# Load libraries

```{r load libraries}
library(Seurat)
packageVersion("Seurat")
library(SoupX)
library(ddqcR)
#devtools::install_github("ayshwaryas/ddqc_R")
#remotes::install_github('chris-mcginnis-ucsf/DoubletFinder')
library(DoubletFinder)
library(parallel)
library(purrr)
library(tibble)
library(presto)
library(dplyr)
library(patchwork)
library(plyr)
library("metap")
library(RColorBrewer)
library(multtest)
library(ggprism)
```

```{r source files}
source("SCIFlexSeq-main/remove_soup.R")
source("SCIFlexSeq-main/find_doublets.R")
source("SCIFlexSeq-main/run_ddqcR.R")
```

# Read in 10X data

Some meta data info:

Sample2 "PBS PreCh1" Sample3 "NP Ch4" Sample4 "PBS Ch4" Sample5 "NP Ch7"
Sample6 "PBS Ch7"

# SoupX

run SoupX from function file "CellRanger_SoupX_Processing.R" params:
sample, data_dir, sample_dir

```{r}
data_dir = "9905_LR_pool2_data/"
sample_list = c("PBSPreCh1", "NPCh4", "PBSCh4", "NPCh7", "PBSCh7")
sample.names = list.files(path = '9905_LR_pool2_data/')
sample.names

folder.names = paste0(sample.names, "/")

sample_dir_list = folder.names

rm(PBSPreCh1, NPCh4, PBSCh4, NPCh7, PBSCh7 )
```

```{r run soupX}
#Install glmGamPoi before running soupX
#BiocManager::install('glmGamPoi')
#library("glmGamPoi")

#rm(sample_list)

#in loop format
#for (x in 1:5) {
#  sample_list[x] = remove_soup(sample_list[x], data_dir, sample_dir_list[x])
#}

PBSPreCh1 = remove_soup(PBSPreCh1, data_dir, sample_dir_list[1])
NPCh4 =  remove_soup(NPCh4, data_dir, sample_dir_list[2])
PBSCh4 = remove_soup(PBSCh4, data_dir, sample_dir_list[3])
NPCh7 = remove_soup(NPCh7, data_dir, sample_dir_list[4])
PBSCh7 = remove_soup(PBSCh7, data_dir, sample_dir_list[5])
#save.image(file = "Allergy_Katepiepeline_v1.RData")

```

# ddqcR

run ddqcR with "filter_ddqcr" function params: seurat object, "sample
name", data_dir, sample_dir

```{r run ddqcR}

PBSPreCh1 = filter_ddqcr(PBSPreCh1, sample_list[1],data_dir, sample_dir_list[1])
NPCh4 =  filter_ddqcr(NPCh4, sample_list[2],data_dir, sample_dir_list[2])
PBSCh4 = filter_ddqcr(PBSCh4, sample_list[3],data_dir, sample_dir_list[3])
NPCh7 = filter_ddqcr(NPCh7, sample_list[4],data_dir, sample_dir_list[4])
PBSCh7 = filter_ddqcr(PBSCh7, sample_list[5],data_dir, sample_dir_list[5])



```

# Run Doublet Finder on Samples

run doublet finder with "find_doublets" function params: seu_object,
"sample name", data_dir, sample_dir

```{r}
```

```{r}
PBSPreCh1 = find_doublets(PBSPreCh1, sample_list[1],data_dir, sample_dir_list[1])
NPCh4 =  find_doublets(NPCh4, sample_list[2],data_dir, sample_dir_list[2])
PBSCh4 = find_doublets(PBSCh4, sample_list[3],data_dir, sample_dir_list[3])
NPCh7 = find_doublets(NPCh7, sample_list[4],data_dir, sample_dir_list[4])
PBSCh7 = find_doublets(PBSCh7, sample_list[5],data_dir, sample_dir_list[5])


```

```{r}
saveRDS(PBSPreCh1, file = "./filtered_pbs_prech1_object.rds")
saveRDS(NPCh4, file = "./filtered_np_ch4_object.rds")

saveRDS(PBSCh4, file = "./filtered_pbs_ch4_object.rds")
saveRDS(NPCh7, file = "./filtered_np_ch7_object.rds")

saveRDS(PBSCh7, file = "./filtered_pbs_ch7_object.rds")
```

```{r}
#Assign an identity to the cells - this is only necessary when you are combining more than one file/Seurat object
PBSPreCh1@meta.data$sample <- "PBS PreCh1"
NPCh4@meta.data$sample <- "NP Ch4"
PBSCh4@meta.data$sample <- "PBS Ch4"
NPCh7@meta.data$sample <- "NP Ch7"
PBSCh7@meta.data$sample <- "PBS Ch7"

PBSPreCh1@meta.data$TP <- "PreCh1"
NPCh4@meta.data$TP <- "Ch4"
PBSCh4@meta.data$TP <- "Ch4"
NPCh7@meta.data$TP <- "Ch7"
PBSCh7@meta.data$TP <- "Ch7"

PBSPreCh1@meta.data$Tx <- "PBS"
NPCh4@meta.data$Tx <- "NP"
PBSCh4@meta.data$Tx <- "PBS"
NPCh7@meta.data$Tx <- "NP"
PBSCh7@meta.data$Tx <- "PBS"
```

# Merge THEN scTransform

Do not run if using scTransform method

```{r}
#Create Seurat objects
# use count matrix to create seurat object, which has data (ie count matrix)
# and analysis (ie PCA/clustering)
# initialized with raw data

PBSPreCh1 <- NormalizeData(PBSPreCh1) # normalize the data with log norm
PBSPreCh1 <- ScaleData(PBSPreCh1, verbose = F) # linear transformation prior to
# dimensional reduction like PCA. Shifts expression so mean exp is 0 across all cells,
# scales exp, so var across cells is 1
# verbose calls progress bar


NPCh4 <- NormalizeData(NPCh4)
NPCh4 <- ScaleData(NPCh4, verbose = F)


PBSCh4 <- NormalizeData(PBSCh4)
PBSCh4 <- ScaleData(PBSCh4, verbose = F)

NPCh7 <- NormalizeData(NPCh7)
NPCh7 <- ScaleData(NPCh7, verbose = F)


PBSCh7 <- NormalizeData(PBSCh7)
PBSCh7 <- ScaleData(PBSCh7, verbose = F)

```

## merge

merge tutorial: <https://satijalab.org/seurat/archive/v4.3/merge>

```{r merge}
SILP = merge(x = PBSPreCh1, y = list( PBSCh4, NPCh4,PBSCh7, NPCh7))

#rm(ctrl, PBS2dpi, NP2dpi, PBS7dpi, NP7dpi)
```

## scTransform

scTransform vignette:
<https://satijalab.org/seurat/articles/sctransform_vignette.html>
install glmGamPoi before using, significantly improves speed
BiocManager::install("glmGamPoi")

```{r}
SILP <- SCTransform(SILP, vars.to.regress = "percent.mt", verbose=F)
saveRDS(SILP, file = "./merge_sct_filtered_spine.rds")
```

```{r}
SILP = readRDS("./merge_sct_filtered_spine.rds")
#SILP <- SCTransform(SILP)
SILP <- RunPCA(SILP)
SILP <- RunUMAP(SILP, dims = 1:30)
SILP[[]]
DimPlot(SILP, reduction = "umap", group.by = c("sample", "seurat_clusters"))
DimPlot(SILP, reduction = "umap", split.by = c("sample"))
```
```{r}
ElbowPlot(SILP, ndims = 50)
SILP <- FindNeighbors(SILP, dims = 1:30, verbose = F)
SILP <- FindClusters(SILP, verbose =F, resolution = 0.3)
DimPlot(SILP, group.by = c("sample", "seurat_clusters"), label=T)

table(Idents(SILP),SILP@meta.data$sample)
```

# Integration
Seurat integration vignette: https://satijalab.org/seurat/articles/integration_introduction.html
Use integration method for SCtransform, not the regular one 
```{r}
int.SILP <- IntegrateLayers(object = SILP, method = CCAIntegration, normalization.method = "SCT", verbose =T)
int.SILP <- FindNeighbors(int.SILP, reduction = "integrated.dr", dims = 1:30)
int.SILP <- FindClusters(int.SILP, res = 0.6)
```

```{r}
int.SILP <- RunUMAP(int.SILP, dims = 1:20, reduction = "integrated.dr")
DimPlot(int.SILP, reduction = "umap", group.by = c( "seurat_clusters"), split.by = c( "Tx"), combine = F)
DimPlot(int.SILP, reduction = "umap", group.by = c( "SCT_snn_res.0.3"), split.by = c( "Tx"), combine = F)


getPalette = colorRampPalette(brewer.pal(9, "Set1"))

png(file = "UMAP_31clusters.png",
    units = "in",width = 11, height = 11, res = 400)
DimPlot(int.SILP, reduction = "umap", label = TRUE, pt.size = 0.5, label.size = 9, repel = T, 
        group.by = "seurat_clusters",
        cols = getPalette(31)) +
  theme_prism(base_size = 18) + theme(legend.text = element_text(size = 28)) +
  labs( title = "UMAP of Cell Types") 
ggsave(file = "UMAP_31clusters.png",
    units = "in",width = 11, height = 11, dpi = 400)
dev.off()

dev.set(dev.prev())

```

```{r}
# visualize
DimPlot(int.SILP, reduction = "umap", group.by = c("sample", "seurat_clusters"))
DimPlot(int.SILP, reduction = "umap", split.by = c("sample"))
DimPlot(int.SILP, reduction = "umap", group.by = c( "seurat_clusters"), split.by = c( "Tx"), combine = F)
DimPlot(SILP, reduction = "umap", group.by = c( "seurat_clusters"), split.by = c( "Tx"), combine = F)

int.SILP$SCT_snn_res.0.3


```

```{r}
table(Idents(int.SILP),int.SILP@meta.data$sample)
```


Save integrated object
```{r}
saveRDS(int.SILP, file = "./sct_integrated_SILP.rds")
```


```{r}
save.image("./LMR_KGpipeline_integrated.SILP.RData")
```

```{r}
# now that integration is complete, rejoin layers
Layers(SILP)
SILP
DefaultAssay(SILP) = "RNA"
SILP <- JoinLayers(SILP)




get_conserved <- function(cluster){
  Seurat::FindConservedMarkers(SILP,
                       ident.1 = cluster,
                       grouping.var = "sample",
                       only.pos = TRUE) %>%
    rownames_to_column(var = "gene")  %>%
    #left_join(y = unique(annotations[, c("gene_name", "description")]),
    #          by = c("gene" = "gene_name")) %>%
    cbind(cluster_id = cluster, .)
}
#devtools::install_github('immunogenomics/presto')
FindConservedMarkers(SILP,
                     ident.1 = 0,
                     grouping.var = "sample",
                     only.pos = TRUE)

#conserved_markers <- map_dfr(unique(new.cluster.ids), get_conserved)


conserved_markers <- map_dfr(0:23, get_conserved)

DefaultAssay(SILP) = "SCT"
head(conserved_markers)
conserved_markers$`PBS PreCh1_avg_log2FC`
# Extract top 10 markers per cluster
top20 <- conserved_markers %>% 
  mutate(avg_fc = (`PBS PreCh1_avg_log2FC` + 
                     `PBS Ch4_avg_log2FC` + 
                     `NP Ch4_avg_log2FC` +
                     `PBS Ch7_avg_log2FC` +
                     `NP Ch7_avg_log2FC`) /5) %>% 
  group_by(cluster_id) %>% 
  top_n(n = 20, 
        wt = avg_fc)




#cluster id

Idents(data)
data <- PrepSCTFindMarkers(data)
all.markers <- FindAllMarkers(data, only.pos = TRUE)

top20=all.markers %>% 
  group_by(cluster) %>% 
  top_n(n = 20, 
        wt = avg_log2FC)

#Not integrated SILP clusters:
# Cluster 0 Eef1akmt3 gastric secreting a lot of IgK
# Cluster 1 
# Cluster 2 CD4+ DC? Itgax/CD11c+ SiglecH
# Cluster 3 T cells CD3 CD4 Foxp3
# Cluster 4 
# Cluster 5 B cells CD19 Ms4a1/CD20
# Cluster 6 NK Klri1 Klra Gzmk
# Cluster 7 
# Cluster 8 T cells CD3 CD4
# Cluster 9 Mast Cells CD3 MCPT1 Fcer1a
# Cluster 10 Neuron? Metalloendopeptidase ADAM-like Decysin 1 (ADAMDEC1) Marker for Inflammatory Bowel Disease https://doi.org/10.3390%2Fijms23095007
# Cluster 11 Slamf7 Sdc1 Plasma?
# Cluster 12 stromal? collagen DCN
# Cluster 13 CD103+ DCs Itgax/CD11c+ Itgae/CD103
# Cluster 14 
# Cluster 15 Mac? CD14 Lyz1

# Cluster 16 CD11b+ DC Itgax/CD11c+ Itgam/CD11b
# Cluster 17 CD19 Slamf7 Sdc1 Plasma?
# Cluster 18
# Cluster 19 Neut? S100a8/a9
# Cluster 20 Mac? Lyz1
# Cluster 21 Mast cells? MCPT1low Fcer1a low
# Cluster 22 mucous glandular cells?
# Cluster 23 B cells CD19 Ms4a1/CD20
```


```{r}
DotPlot(SILP, features = c( "Ptprc", "Cd33",
                            "Cd3e", "Cd4", "Cd8a","Foxp3","Ctla4", 
                            "Ncr1", "Klrb1c", "Klre1", 
                            "Cd79a", "Cd19" ,"Ms4a1", "Ighm", 
                            "Cd300a", "Ly6c2", "Cd14", "Ccr2", 
                            "Smox", "Apoe", "Ms4a7", "Ccr5", "Fcgr1", "Adgre1", "Cd68",
                            "Ftl1", "Fth1", 
                            "Tmem119", "Trem2", "Aif1", "Csf1r",
                            "S100a9", "Camp", "Retnlg", "Ly6g",
                            "Ifitm1", "Siglech", "Klk1", 
                            "Zbtb46", "Itgax", "Cd86", "Cd209a",
                            "Bst2", "Cmah", "Ly6a", "Nrp1", "Clec4g", 
                            "Cacnb3", "Fscn1", "Syn3", "Tmem150c", 
                            "Snca", "Ube2o"
)) + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")
```
```{r}
# now that integration is complete, rejoin layers
Layers(int.SILP)
int.SILP
DefaultAssay(int.SILP) = "RNA"
int.SILP <- JoinLayers(int.SILP)



get_conserved <- function(cluster){
  Seurat::FindConservedMarkers(int.SILP,
                       ident.1 = cluster,
                       grouping.var = "sample",
                       only.pos = TRUE) %>%
    rownames_to_column(var = "gene")  %>%
    #left_join(y = unique(annotations[, c("gene_name", "description")]),
    #          by = c("gene" = "gene_name")) %>%
    cbind(cluster_id = cluster, .)
}
#devtools::install_github('immunogenomics/presto')
cons_30 = FindConservedMarkers(int.SILP,
                     ident.1 = 30,
                     grouping.var = "sample",
                     only.pos = TRUE)



#conserved_markers <- map_dfr(unique(new.cluster.ids), get_conserved)
view(int.SILP@meta.data)
Idents(int.SILP)
conserved_markers_int <- map_dfr(0:30, get_conserved)

DefaultAssay(int.SILP) = "SCT"
head(conserved_markers_int)
conserved_markers_int$`PBS PreCh1_avg_log2FC`
# Extract top 10 markers per cluster
top20.int <- conserved_markers_int %>% 
  mutate(avg_fc = (`PBS PreCh1_avg_log2FC` + 
                     `PBS Ch4_avg_log2FC` + 
                     `NP Ch4_avg_log2FC` +
                     `PBS Ch7_avg_log2FC` +
                     `NP Ch7_avg_log2FC`) /5) %>% 
  group_by(cluster_id) %>% 
  top_n(n = 20, 
        wt = avg_fc)

top20.int_30 <- cons_30 %>% 
  mutate(avg_fc = ( 
                     
                    
                     `PBS Ch7_avg_log2FC` +
                     `NP Ch7_avg_log2FC`) /5) %>% 
  top_n(n = 20, 
        wt = avg_fc)


#cluster id

Idents(data)
data <- PrepSCTFindMarkers(data)
all.markers.int <- FindAllMarkers(data, only.pos = TRUE)

top20=all.markers %>% 
  group_by(cluster) %>% 
  top_n(n = 20, 
        wt = avg_log2FC)


```
```{r}

#Int.SILP clusters: 
# Cluster 0 Plasma Cells? Jchain Sdc1 Tnfrsf13b Slamf7
# Cluster 1 ILC type 3 Rorc+ Th17 https://doi.org/10.1016/j.cell.2016.07.043 NK? Ncr1 No CD45/Ptprc
# Cluster 2 DCs CD4+ Cd8b1 in NP? DC? Itgax/CD11c+ SiglecH DC-sign(Cd209a/d) Clec9a
# Cluster 3 Naive? B cell Cd19 Ighd Cd22 Cd40 Cd20 Mhc
# Cluster 4 Tgd? cells CD3 CD4 Tcrg-V4 
# Cluster 5 ?? Ighm No CD45 Jchain
# Cluster 6 ILC type 3 Rorc+ Th17 https://doi.org/10.1016/j.cell.2016.07.043
# Cluster 7 ILC type 3 Gata3+ Th2 https://doi.org/10.1016/j.cell.2016.07.043
# Cluster 8 NK Ncr1 Klre1 Klri1 Gmza
# Cluster 9 Mast Cells CD3 MCPT1 Fcer1a No CD45? Kit/CD117+
# Cluster 10 Plasma?? Ighg1 Igha Jchain Sdc1 No CD45
# Cluster 11 Mac?? or Eosinophil? f4/80/Adgre1 (apprently eosinophil have F4/80 in mice) Metalloendopeptidase ADAM-like Decysin 1 (ADAMDEC1) Marker for Inflammatory Bowel Disease https://doi.org/10.3390%2Fijms23095007
# Cluster 12 Treg Cd3 CD4 Foxp3 Il10 Ctla4
# Cluster 13 ?? No CD45 low Jchain
# Cluster 14 Different kind of Treg? Cd3 Cd4 Foxp3 Gzma Gzmb Il10 Cd5
# Cluster 15 ?? No CD45 low Jchain
# Cluster 16 Cd103+ DC Cd86 Clec9a Itgae/Cd103 Mhc
# Cluster 17 Stromal Collagen DCn No CD45
# Cluster 18 Th2 T cells Cd3 Cd4 Il17rb Il4 Gata3 Il13 Il5
# Cluster 19 ? low exp Cd3 Cd4 low Jchain? No CD45
# Cluster 20 ? low exp Cd3 Np Cd4? Jchain No CD45
# Cluster 21 Plasma? Jchain No CD45
# Cluster 22 Plasma? Jchain No CD45
# Cluster 23 Neut?  S100a8/9 has CD45
# Cluster 24 Mac/Mon/eosinophil>??? Mhc Cd14 Apoe Lyz2 Adgre1/f4/80 Itgam Fcgr3/Cd16 
# Cluster 25 Plasma? Jchain Igha No CD45
# Cluster 26 Plasma? Jchain Igha Ly6a/m? No CD45
# Cluster 27 CD8 T cell Cd3 Cd8a Cd8b Tcrg-V7 Ifng
# Cluster 28 B cells Cd19 Cd20 Mhc
# Cluster 29 ILC type 3 Rorc+ Th17 https://doi.org/10.1016/j.cell.2016.07.043
# Cluster 30 ?? No CD45 low Jchain

names(int.SILP.clustering.list) = c("Cluster 1", "Cluster 2")
int.SILP.clustering.list = list(
  list(
    Bcell = c("Jchain", "Ighe", "Igha")
  ),
  
  list(
    Th17 = c("Rorc", "Ly6g5b"),
    Enteroendocrine = c("Ly6g5b")
  )
)


int.SILP.clustering.list[[2]]$Th17


int.SILP.Clustering.df = data.frame(
  Cluster1 = c("B cell"),
  Cluster2 = c("Tcell", "Enteroendocrine"),
  Cluster3 = c("")
)



Idents(int.SILP)
unique(Idents(int.SILP))

int.SILP = RenameIdents(int.SILP, 
             "0" = "Plasma Cells",
             "1" = "ILC",#"Th17 ILC",
             "2" = "Myeloid",#"DCs",
             "3" = "B Cells",
             "4" = "CD4 T Cells",
             "5" = "Plasma Cells",
             "6" = "ILC",#"Th17 ILC",
             "7" = "ILC",#"Th2 ILC",
             "8" = "NK",
             "9" = "Mast Cells",
             "10" = "Plasma Cells",
             "11" = "Myeloid",
             "12" = "CD4 T Cells",
             "13" = "Plasma Cells",
             "14" = "CD4 T Cells",
             "15" = "Plasma Cells",
             "16" = "Myeloid",#"DCs",
             "17" = "Stromal Cells",
             "18" = "CD4 T Cells",
             "19" = "Plasma Cells",
             "20" = "Plasma Cells",
             "21" = "Plasma Cells",
             "22" = "Plasma Cells",
             "23" = "Myeloid",
             "24" = "Myeloid",
             "25" = "Plasma Cells",
             "26" = "Plasma Cells",
             "27" = "CD8 T Cells",
             "28" = "B Cells",
             "29" = "ILC",#"Th17 ILC",
             "30" = "Plasma Cells"
             )

int.SILP$test.ids = Idents(int.SILP)
Idents(int.SILP) = int.SILP$seurat_clusters

DimPlot(int.SILP, reduction = "umap", group.by = c( "test.ids"), 
        #split.by = c( "Tx"), 
        combine = F, label = T)


DimPlot(int.SILP, reduction = "umap", label = TRUE, pt.size = 0.5, label.size = 9, repel = T, 
        group.by = "test.ids",
        cols = getPalette(9)) +
  theme_prism(base_size = 16, base_fontface = "bold") + 
  theme(legend.text = element_text(size = 18)) +
  labs( title = "UMAP of Cell Types") 
ggsave(file = "UMAP_9clusters.png",
    units = "in",width = 11, height = 11, dpi = 400)

DimPlot(int.SILP, reduction = "umap", group.by = c("SCT_snn_res.0.8"), split.by = c( "Tx"), combine = F, label = T)

table(int.SILP$test.ids,int.SILP$sample)

CellTypeTable = as.data.frame(proportions(table(int.SILP$test.ids,
                                                int.SILP$sample), 
                                          margin = 2))
CellTypeTable$Freq = CellTypeTable$Freq*100
levels(CellTypeTable$Var1)

getPalette = colorRampPalette(brewer.pal(9, "Set1"))
#display.brewer.all()
CellTypeTable[which(CellTypeTable$Var1 == "DCs"),]


CellTypeTable$Var2 = factor(CellTypeTable$Var2, levels = c("PBS PreCh1", "PBS Ch4", "PBS Ch7", "NP Ch4", "NP Ch7"))
#png(file = "CellProportions_24clusters.png",units = "in",width = 14, height = 13, res = 400)
ggplot(CellTypeTable,aes(x=Var2,y=Freq,fill=Var1)) + 
  geom_col(width = 0.5, color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, .1)))+
  theme_prism( base_size = 16)+
  labs(x = "Condition", y= "Percent of Cells") + 
  scale_fill_manual(values = getPalette(length(unique(int.SILP$test.ids))), name = "Cell Type") + 
  theme(legend.text = element_text(size = 16), 
        axis.text.x = element_text(angle = 50, hjust = 1, vjust = 1)
        #plot.title = element_text(hjust = 0.5)
  )
ggsave(file = "CellProportions_9clusters.png",
    units = "in",width = 11, height = 11, dpi = 400)
dev.off()


```
```{r}
table(Idents(int.SILP),int.SILP@meta.data$sample)
```

```{r}

immune.markers.paper = read.csv("mmc2.csv",
                                check.names=FALSE,header=T, sep=",")
unique(immune.markers.paper$Column2)

immune.markers.paper[which(immune.markers.paper$Column2 == "Macrophage" | immune.markers.paper$Column2 == "Macrophages"),3]

plots <- VlnPlot(int.SILP, features = c("Cd3e", "Cd4", "Cd8a","Cd8b1"), 
                 split.by = "Tx",
                 group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)


plots <- VlnPlot(int.SILP, features = c("Cd3e", "Cd4", "Cd8a","Cd8b1", "Cd19", "Ms4a1", "Sdc1", "Cd27", "Slamf7"), 
                 split.by = "Tx",
                 group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)


#macs
c("Marco", "Itgam", "Adgre1",
                               "Apoe","Cd14", "Lyz",
                               "Ms4a7", "Pf4", "Fapb4", "Gpnmb", "Gpr84"
)

#stromal
c("Ptprc","Col1a1", "Col6a1", "Dcn", "Lum", "Postn", "Eef1akmt3"
                               
)


#mast cell
c(
  "Mcpt1", "Fcer1a", "Ighe", "Kit", "Itgb7"
)

DotPlot(int.SILP, features = c(
  "Mcpt1", "Fcer1a", "Ighe", "Kit", "Itgb7"
                               ), group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")


DotPlot(int.SILP, features = c("Jchain","S100a9", "S100a8",
                               "Ccr3", "Epx", "Edn1", "Siglecf",
                               "Il1a", "Lin28a", "Fcgr3",
                               "Mki67", "Tuba1b", "Prg3", "Ear1", "Ear2", "Ear6", "Alox15", "S100a6", "S100a10", "Aldh2", "Il5",
                            "Itgam", "Il5ra","Siglec5"

                               ), group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")

DotPlot(int.SILP, features = 
          unique(immune.markers.paper[which(immune.markers.paper$Column2 == "Macrophage" | immune.markers.paper$Column2 == "Macrophages"),3])
          , group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")

DotPlot(int.SILP, features = 
          unique(immune.markers.paper[which(immune.markers.paper$Column2 == "monocyte" | immune.markers.paper$Column2 == "Monocyte" 
                                            | immune.markers.paper$Column2 == "Monocytes"),3])
          , group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")

DotPlot(int.SILP, features = 
          unique(immune.markers.paper[which(immune.markers.paper$Column2 == "NK_cells" |immune.markers.paper$Column2 == "NK_cell"|
                                              immune.markers.paper$Column2 == "NK"),3])
          , group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")

DotPlot(int.SILP, features = c("Itgam", "Itgax")
          , group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")


DotPlot(int.SILP, features =c("Tbx21", "Gzmb", "Gzmc","Il7r",
                              "Cd3e","Cd5","Cx3cl1","Rorc",
                              "Gata3","Ifng","Il4","Il22","Il17a",
                              "Foxs1","Gpx1","Tcf7", "Cxcl2","Podnl1","Socs3",
                              "Atf3", "Maff", "Ostf1","Rcor1","Smox",
                              "Ccl20", "Tnfsf11","Il23r","Lta","Tnf",
                              "Hk2", "Hk3", "Pfki", "Pfkp","Eno1","Ldhb",
                              "Bpgm","Tns4","Tns3","Arg1","Pdk1","Mgll",
                              "Mtmr12","Plcg2")
          , group.by = "seurat_clusters") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")


DotPlot(int.SILP, features = top20.int[which(top20.int$cluster_id == "11"),2]
          , group.by = "test.ids") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red")


plots <- VlnPlot(int.SILP, features = c("Cd19", "Ms4a1", "Sdc1", "Tnfrsf13b", "Slamf7", "Ifngr1", "Cd27"), 
                 split.by = "sample",
                 group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)

FeaturePlot(int.SILP, 
            reduction = "umap", 
            features = c("Cd4", "Cd8a", "Cd8b1"), 
            #sort.cell = TRUE,
            min.cutoff = 'q10', 
            label = TRUE)

plots <- VlnPlot(int.SILP, features = c("Ptprc", "Flt1", "Ly6a",
                                    "Id3", "Fhl2", "Gng11", "Cd34", "Acvrl1",
                                    "Itgb3", "Vcam1", "Thbd", "Cd55", "Vegfa", "Vegfd",
                                    "Ece1", "Plec", "Ecscr","Tgfbr2", "Icam1"), split.by = "Tx",
                 group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 3)

plots <- VlnPlot(int.SILP, features = c("Cd14", "Lyz1"), 
                 split.by = "Tx",
                 group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 3)

#DCs
plots <- VlnPlot(int.SILP, features = c("Cd209a", "Btla", "Flt3", "Itgax", #cd11c
                                    "Clec9a", "Ly75", "Sirpa", "Bst2", "Itgae", #CD103
                                    "Itgam", #Cd11b
                                    "Cd80", "Cd86", "Il4i1"
), 
split.by = "Tx",
group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)

plots <- VlnPlot(int.SILP, features = c("Flt3","H2-DMb1", "H2-DMb2","H2-Eb1", "H2-Aa", "H2-Ab1", "H2-DMa",
                                    "Cd80", "Cd86", "Cd83"
), 
split.by = "sample",
group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)
Idents(TNBC) = "seurat_clusters"
DCs_types_markers <- FindConservedMarkers(int.SILP, ident.1 = "14", ident.2 =  c("7", "12"),grouping.var = "Antigen",
                                          verbose = FALSE)

data[[]]
plots <- VlnPlot(int.SILP, features = c(
  "Mcpt1", "Fcer1a", "Ighe", "Kit", "Itgb7"
), 
split.by = "Tx",
group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)

FeaturePlot(int.SILP, 
            reduction = "umap", 
            features = c("Mcpt1", "Fcer1a", "Ighe", "Kit", "Itgb7"), 
            #sort.cell = TRUE,
            min.cutoff = 'q10', 
            label = TRUE)

plots <- VlnPlot(int.SILP, features = c(
  "S100a8", "S100a9"
), 
split.by = "Tx",
group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)

plots <- VlnPlot(int.SILP, features = c(
  "Ncr1", "Klrb1a", "Klre1"
), 
split.by = "Tx",
group.by = "seurat_clusters", pt.size = 0, combine = FALSE)
wrap_plots(plots = plots, ncol = 2)



```


#Plots 

```{r}


DimPlot(int.SILP, reduction = "umap", label = TRUE, pt.size = 0.5, label.size = 9, repel = T, 
        group.by = "test.ids",
        cols = getPalette(9)) +
  theme_prism(base_size = 16, base_fontface = "bold") + 
  theme(legend.text = element_text(size = 18)) +
  labs( title = "UMAP of Cell Types") 
ggsave(file = "UMAP_9clusters.png",
    units = "in",width = 11, height = 11, dpi = 400)

DimPlot(int.SILP, reduction = "umap", group.by = c("SCT_snn_res.0.8"), split.by = c( "Tx"), combine = F, label = T)

table(int.SILP$test.ids,int.SILP$sample)

CellTypeTable = as.data.frame(proportions(table(int.SILP$test.ids,
                                                int.SILP$sample), 
                                          margin = 2))
CellTypeTable$Freq = CellTypeTable$Freq*100
levels(CellTypeTable$Var1)

getPalette = colorRampPalette(brewer.pal(9, "Set1"))
#display.brewer.all()
CellTypeTable[which(CellTypeTable$Var1 == "DCs"),]


CellTypeTable$Var2 = factor(CellTypeTable$Var2, levels = c("PBS PreCh1", "PBS Ch4", "PBS Ch7", "NP Ch4", "NP Ch7"))
#png(file = "CellProportions_24clusters.png",units = "in",width = 14, height = 13, res = 400)
ggplot(CellTypeTable,aes(x=Var2,y=Freq,fill=Var1)) + 
  geom_col(width = 0.5, color = "black") +
  scale_y_continuous(expand = expansion(mult = c(0, .1)))+
  theme_prism( base_size = 16)+
  labs(x = "Condition", y= "Percent of Cells") + 
  scale_fill_manual(values = getPalette(length(unique(int.SILP$test.ids))), name = "Cell Type") + 
  theme(legend.text = element_text(size = 16), 
        axis.text.x = element_text(angle = 50, hjust = 1, vjust = 1)
        #plot.title = element_text(hjust = 0.5)
  )
ggsave(file = "CellProportions_9clusters.png",
    units = "in",width = 11, height = 11, dpi = 400)
dev.off()


#Cluster IDs
DotPlot(int.SILP, features =c(
  "Ptprc", #CD45
  "Cd3e", "Cd4", "Cd8a", "Cd8b1", # Tcells
  "Il7r","Cd5","Rorc","Gata3", "Maff","Il23r", #ILC
  "Mcpt1", "Fcer1a", "Kit", #Mast Cells
  "Xcl1","Ncr1", "Klre1", "Klri1", "Gzma", "Gzmb",#NK
  "Col4a1","Flt1","Nkx2-3", "Tie1", #Stromal
  "Itgam", "Itgax", "Adgre4","Adgre1","Cd80", "Clec9a",
  "H2-DMb1", "H2-DMb2","H2-Eb1", "H2-Aa", "H2-Ab1", "H2-DMa", #Myeloid
  "Cd19",  "Ms4a1","Ighd","Ighm", "Cd22", #Bcells
  "Jchain", "Sdc1", "Tnfrsf13b", "Igha", "Ighe"  #Plasma 
  )
          , group.by = "test.ids") + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red") +  theme_prism(base_family = "Arial", base_size = 20) +
  theme(axis.text.x =element_text(angle = 45, hjust=1, vjust = 1))

ggsave(file = "DotplotMarkergenes_9clusters.png",
    units = "in",width = 17, height = 8, dpi = 400)

CellTypeData = CellTypeTable
# load stringr library
library(stringr)
library(ggpubr)

# Split name column into firstname and last name
CellTypeData[c('Tx', 'TP')] <- str_split_fixed(CellTypeData$Var2, ' ', 2)

plotCellType = function(data, celltype){
  ggplot(data[which(data$Var1 == celltype),], aes(x = Tx, y= Freq, fill = TP)) + 
    geom_bar(position = position_dodge(),stat = 'identity') +
    scale_y_continuous(expand = expansion(mult = c(0, .1)))+
    theme_prism(base_family = "Arial", base_size = 12)+
    labs( y= "Percent of Cells", title = paste(celltype)) + 
    theme(legend.text = element_text(size = 12) 
    ) + xlab(NULL)
}

CellTypeData$Tx = factor(CellTypeData$Tx, levels = c("PBS", "NP"))
myplots = lapply(unique(CellTypeData$Var1), FUN = plotCellType, data = CellTypeData)

#png(file = "CellProportions_24clusters_individual_grid.png", units = "in",width = 20, height = 16, res = 400)
ggarrange(plotlist = myplots, ncol=6, nrow=4, 
          common.legend = T, legend = "top")
dev.off()

plotCellTypePresentation = function(data,celltype){
  ggplot(data[which(data$Var1 == celltype),], aes(x = Tx, y= Freq, fill = TP)) + 
    geom_bar(position = position_dodge(),stat = 'identity', width = 0.3) +
    scale_y_continuous(expand = expansion(mult = c(0, .1)))+
    theme_prism(base_family = "Arial", base_size = 16)+
    labs(x = "Condition", y= "Percent of Cells", title = paste(celltype)) + 
    theme(legend.text = element_text(size = 16)
    )
}

CellTypeData$TP = factor(CellTypeData$TP, levels = c("PreCh1", "Ch4", "Ch7"))


plotCellTypePresentation(CellTypeData, "ILC")


myplots = lapply(unique(CellTypeData$Var1), FUN = plotCellTypePresentation, data = CellTypeData)

png(file = "ImmuneCell_prop.png",
    units = "in",width = 17, height = 4, res = 400)
ggarrange(plotlist = myplots, ncol=5, nrow=2, 
          common.legend = T, legend = "right")

ggsave(file = "ImmuneCell_prop.png",
    units = "in",width = 17, height = 10, dpi = 400)
dev.off()




```



#Subcluster B cells

```{r}
Idents(int.SILP) = int.SILP$test.ids

names(int.SILP@graphs)

int.SILP = FindSubCluster(
  object = int.SILP,
  cluster = "B Cells",
  graph.name = "SCT_nn",
  resolution = 0.5,
  subcluster.name = "B Cells Subtypes",
  algorithm = 2
)

unique(int.SILP$`B Cells Subtypes`)

Idents(int.SILP) = int.SILP$`B Cells Subtypes`

DimPlot(int.SILP, reduction = "umap", split.by = c( "Tx"), combine = F, label = T)

table(Idents(Bcells),Bcells@meta.data$sample)



Idents(int.SILP) = int.SILP$test.ids
Bcells = subset(x = int.SILP, idents = "B Cells")
Bcells <- FindNeighbors(Bcells, reduction = "integrated.dr", dims = 1:30)
Bcells <- FindClusters(Bcells, res = 0.3, graph.name = "SCT_nn")
Bcells <- RunUMAP(Bcells, dims = 1:20, reduction = "integrated.dr")

DimPlot(Bcells, reduction = "umap", split.by = c( "Tx"), combine = F, label = T)


get_conserved <- function(cluster){
  Seurat::FindConservedMarkers(Bcells,
                       ident.1 = cluster,
                       grouping.var = "sample",
                       only.pos = TRUE) %>%
    rownames_to_column(var = "gene")  %>%
    #left_join(y = unique(annotations[, c("gene_name", "description")]),
    #          by = c("gene" = "gene_name")) %>%
    cbind(cluster_id = cluster, .)
}
unique(Idents(Bcells))

conserved_markers.Bcells <- map_dfr(0:5, get_conserved)
conserved_markers.Bcells[is.na(conserved_markers.Bcells)] <- 0

DefaultAssay(Bcells) = "SCT"
head(conserved_markers.Bcells)
conserved_markers$`PBS PreCh1_avg_log2FC`
# Extract top 10 markers per cluster
conserved_markers.Bcells <- conserved_markers.Bcells %>% 
  mutate(avg_fc = (`PBS PreCh1_avg_log2FC` + 
                     `PBS Ch4_avg_log2FC` + 
                     `NP Ch4_avg_log2FC` +
                     `PBS Ch7_avg_log2FC` +
                     `NP Ch7_avg_log2FC`) /5)



top20.Bcells = top_n(
    conserved_markers.Bcells[which(conserved_markers.Bcells$cluster_id == 0),],
        n = 20, 
        wt = avg_fc)

for(i in 1:5){
  
 
   subset = top_n(
  conserved_markers.Bcells[which(conserved_markers.Bcells$cluster_id == 5),],
  n = 20, 
        wt = avg_fc)
  
  top20.Bcells = rbind(top20.Bcells, subset)
}

DotPlot(Bcells, features =c(
  "Ptprc", #CD45
  "Cd3e", "Cd4", "Cd8a", "Cd8b1", # Tcells
  "Il7r","Cd5","Rorc","Gata3", "Maff","Il23r", #ILC
  "Mcpt1", "Fcer1a", "Kit", #Mast Cells
  "H2-DMb1", "H2-DMb2","H2-Eb1", "H2-Aa", "H2-Ab1", "H2-DMa", #Myeloid
  "Cd19",  "Ms4a1","Ighd","Ighm", "Cd22", #Bcells
  "Jchain", "Sdc1", "Tnfrsf13b", "Igha", "Ighe", "Ighg1", "Ighg2b", "Ighg2c", "Ighg3"  #Plasma 
  )
          ) + 
  RotatedAxis() + scale_colour_gradient2(low = "blue", mid = "grey", high = "red") 
  
colnames(Bcells[[]])

Idents(Bcells)

B0 = subset(x = Bcells, idents = "0")
B1 = subset(x = Bcells, idents = "1")
B2 = subset(x = Bcells, idents = "2")
Idents(B0) = B0$sample
Idents(B1) = B1$sample
Idents(B2) = B2$sample

B0 = PrepSCTFindMarkers(B0)
B1 = PrepSCTFindMarkers(B1)
B2 = PrepSCTFindMarkers(B2)
B0_ch7_PBSvNP = FindMarkers(B0, ident.1 = "PBS Ch7", ident.2 = "NP Ch7", assay= "SCT",
                            recorrect_umi = FALSE)
B1_ch7_PBSvNP = FindMarkers(B1, ident.1 = "PBS Ch7", ident.2 = "NP Ch7", assay= "SCT",
                            recorrect_umi = FALSE)
B2_ch7_PBSvNP = FindMarkers(B2, ident.1 = "PBS Ch7", ident.2 = "NP Ch7", assay= "SCT",
                            recorrect_umi = FALSE)

B0_ch7_PBSvNP$symbol = rownames(B0_ch7_PBSvNP)
B1_ch7_PBSvNP$symbol = rownames(B1_ch7_PBSvNP)
B2_ch7_PBSvNP$symbol = rownames(B2_ch7_PBSvNP)

library(msigdbr)
library(dplyr)
library(tibble)
library(clusterProfiler)
library(ggplot2)
library(forcats)
library(EnhancedVolcano)

all_gene_sets = msigdbr(species = "Mus musculus")
unique(all_gene_sets$gs_subcat)
unique(all_gene_sets$gs_cat)

kegg_gene_sets_msig = msigdbr(species = "mouse", category = "C2", subcategory = "CP:KEGG")


biocarta_gene_sets = msigdbr(species = "mouse", category = "C2", subcategory = "CP:BIOCARTA")

Reactome_gene_sets = msigdbr(species = "mouse", subcategory = "CP:REACTOME")
Wiki_gene_sets = msigdbr(species = "mouse", subcategory = "CP:WIKIPATHWAYS")

HM_gene_sets = msigdbr(species = "mouse", category = "H")

GO_gene_sets = msigdbr(species = "mouse", subcategory = "GO:BP")


B0_ch7_PBSvNP_geneList =  B0_ch7_PBSvNP %>%
  arrange(desc(avg_log2FC)) %>%
  dplyr::select(symbol, avg_log2FC)

B0_ch7_PBSvNP_ranks<- deframe(B0_ch7_PBSvNP_geneList)

B1_ch7_PBSvNP_geneList =  B1_ch7_PBSvNP %>%
  arrange(desc(avg_log2FC)) %>%
  dplyr::select(symbol, avg_log2FC)

B1_ch7_PBSvNP_ranks<- deframe(B1_ch7_PBSvNP_geneList)


B2_ch7_PBSvNP_geneList =  B2_ch7_PBSvNP %>%
  arrange(desc(avg_log2FC)) %>%
  dplyr::select(symbol, avg_log2FC)

B2_ch7_PBSvNP_ranks<- deframe(B2_ch7_PBSvNP_geneList)


combined_data_set = rbind(kegg_gene_sets_msig, 
                          biocarta_gene_sets,
                          Reactome_gene_sets,
                          Wiki_gene_sets,
                          HM_gene_sets,
                          GO_gene_sets)

pathway_gene_set = combined_data_set[,c("gs_name", "gene_symbol")]




y = GSEA(B0_ch7_PBSvNP_ranks,
         pvalueCutoff = 0.5,
         pAdjustMethod = "fdr",
         #OrgDb = org.Mm.eg.db, 
         #TERM2GENE = CTD_gene_sets,
         #TERM2GENE = kegg_gene_sets_msig[,c("gs_description", "entrez_gene")],
         #TERM2GENE = biocarta_gene_sets[,c("gs_description", "entrez_gene")],
         #TERM2GENE = Reactome_gene_sets[,c("gs_description", "entrez_gene")],
         TERM2GENE = pathway_gene_set,
         minGSSize = 1
         
)

y1 = GSEA(B1_ch7_PBSvNP_ranks,
         pvalueCutoff = 0.5,
         pAdjustMethod = "fdr",
         #OrgDb = org.Mm.eg.db, 
         #TERM2GENE = CTD_gene_sets,
         #TERM2GENE = kegg_gene_sets_msig[,c("gs_description", "entrez_gene")],
         #TERM2GENE = biocarta_gene_sets[,c("gs_description", "entrez_gene")],
         #TERM2GENE = Reactome_gene_sets[,c("gs_description", "entrez_gene")],
         TERM2GENE = pathway_gene_set,
         minGSSize = 1
         
)

y2 = GSEA(B2_ch7_PBSvNP_ranks,
         pvalueCutoff = 0.5,
         pAdjustMethod = "fdr",
         #OrgDb = org.Mm.eg.db, 
         #TERM2GENE = CTD_gene_sets,
         #TERM2GENE = kegg_gene_sets_msig[,c("gs_description", "entrez_gene")],
         #TERM2GENE = biocarta_gene_sets[,c("gs_description", "entrez_gene")],
         #TERM2GENE = Reactome_gene_sets[,c("gs_description", "entrez_gene")],
         TERM2GENE = pathway_gene_set,
         minGSSize = 1
         
)


head(y)

y_filt = y[which(abs(y$qvalue)<0.25),]
#y_filt = as.data.frame(y)

y_filt$Condition = "PBS"
y_filt[which((y_filt$NES)<0),]$Condition = "NP" 

y_filt$Day = "Challenge 7"
y_filt$Subset = "Cluster 0 Bcells"

y_filt1 = y1[which(abs(y1$qvalue)<0.25),]
#y_filt = as.data.frame(y)

y_filt1$Condition = "PBS"
y_filt1[which((y_filt1$NES)<0),]$Condition = "NP" 

y_filt1$Day = "Challenge 7"
y_filt1$Subset = "Cluster 1 Bcells"

y_filt2 = y2[which(abs(y2$qvalue)<0.25),]
#y_filt = as.data.frame(y)

y_filt2$Condition = "PBS"
y_filt2[which((y_filt2$NES)<0),]$Condition = "NP" 

y_filt2$Day = "Challenge 7"
y_filt2$Subset = "Cluster 2 Bcells"

y_filt3 = rbind(y_filt, y_filt1, y_filt2)

y_filt3 = y_filt3[which(abs(y_filt3$NES)>1.9),]

ggplot(y_filt3, aes(x = Subset, y = fct_reorder(Description, abs(NES)))) + 
  geom_point(aes(color = abs(NES), size = qvalue) ) +
  theme_bw(base_size = 14) +
  scale_colour_gradient2( low = "blue",high="red", mid = "white",na.value = "black") +
  ylab(NULL) +
  ggtitle("Biocarta Pathways GSEA at Challenge 7 in SILP") +
  facet_grid(~Condition) +
  guides(size = guide_legend(override.aes=list(shape=1))) +
  theme(panel.grid.major.y = element_line(linetype='dotted', color='#808080'),
        panel.grid.major.x = element_blank(),
        legend.text = element_text(size = 16),
        plot.title = element_text(size = 16, face = "bold"),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.text.x =element_text(size = 16, face = "bold"),
        axis.title.x = element_blank(),
        strip.text.x  = element_text(size = 16, face = "bold")) 
ggsave(file = "BcellsubsetGSEA.png",
    units = "in",width = 25, height = 20, dpi = 400)

data = B0_ch7_PBSvNP
keyvals <- ifelse(
  (data$avg_log2FC < -1.5 & data$p_val_adj <0.05), 'royalblue',
  ifelse((data$avg_log2FC > 1.5 & data$p_val_adj < 0.05), 'red',
         'black'))
keyvals[is.na(keyvals)] <- 'black'
names(keyvals)[keyvals == 'black'] <- 'Not DEG'
names(keyvals)[keyvals == 'red'] <- 'PBS'
names(keyvals)[keyvals == 'royalblue'] <- 'NP'

#png(file = "AllergyScaf_NPPBSCh4_VolcanoPlot.png",units = "in",width = 10, height = 10, res = 400)
EnhancedVolcano(data,
                lab = rownames(data),
                x = 'avg_log2FC',
                y = 'p_val_adj',
                pCutoff = 0.05,
                FCcutoff = 1.5,
                colCustom = keyvals,
                selectLab = rownames(data)[which(names(keyvals) %in% c('NP', 'PBS'))],
                title = "DEGs b/w NP and PBS at Challenge 7",
                drawConnectors = F,
                widthConnectors = 0.75,
                boxedLabels = F)
dev.off()


```


